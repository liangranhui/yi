(function(global,undefined){if(global.yi)return;var Yi=function(){this.relativePath="";this.themeManager=null;this.mod=new ModManager;this._readyCallbacks=[];this._dialogTimer=0;var self=this;var ready=function(event){self._setup();if(typeof window.addEventListener!="undefined")window.removeEventListener("load",ready,false);else window.detachEvent("onload",ready)};if(typeof window.addEventListener!="undefined")window.addEventListener("load",ready,false);else window.attachEvent("onload",ready)};Yi.prototype.ready=
function(callback){this._readyCallbacks.push(callback)};Yi.prototype.config=function(relativePath,addition,excluded){if(relativePath.lastIndexOf("/")!=relativePath.length-1)relativePath+="/";this.relativePath=relativePath;this.mod.context=relativePath;var alias=addition!==undefined?addition:{};alias["class"]="utils/class.js";alias["utils"]="utils/utils.js";alias["map"]="utils/hashmap.js";alias["extend"]="utils/extend.js";alias["observable"]="utils/observable.js";alias["delayed-task"]="utils/delayed-task.js";
alias["event"]="utils/event.js";alias["holder"]="utils/holder.js";alias["console"]="core/console/console.min.js";alias["dialog"]="plugins/bootbox.min.js";alias["menu-aim"]="plugins/jquery.menu-aim.js";alias["rating"]="plugins/raty/jquery.raty.min.js";alias["verify"]="plugins/parsley/parsley.min.js";alias["switch"]="plugins/bootstrap-switch/switch.js";alias["fetch"]="plugins/fetch/jquery.fetch.js";alias["theme-manager"]="modules/misc/theme-manager.min.js";alias["component"]="modules/components/component.js";
alias["card-layout"]="modules/components/card-layout/card-layout.js";alias["form"]="modules/components/form/form.js";alias["gallery"]="modules/components/gallery/gallery.js";alias["graph-radio-group"]="modules/components/graph-radio-group/graph-radio-group.js";alias["modal"]="modules/components/modal-window/modal-window.js";alias["tab"]="modules/components/tab/tab.js";alias["timeline"]="modules/components/timeline/timeline.js";alias["clickable"]="modules/components/clickable/clickable.js";alias["button"]=
"modules/components/button/button.js";alias["carousel"]="modules/components/carousel/carousel-roundabout.js";alias["date-format"]="utils/date-format.js";common.config({base:relativePath+"lib/",alias:alias})};Yi.prototype._setup=function(){var readyCount=0;var readyConst=5;var self=this;common.use("theme-manager",function(ThemeManager){self.themeManager=new ThemeManager;checkReady()});common.use("dialog",function(){bootbox.setDefaults({locale:"zh_CN"});checkReady()});common.use("fetch",function(){checkReady()});
common.use("plugins/parsley/i18n/messages.zh_cn.js",function(){common.use("verify",function(){self._fitParsley();checkReady()})});common.use("rating",function(){self._fitRaty();checkReady()});function checkReady(){++readyCount;if(readyCount==readyConst){if(self._readyCallbacks.length>0)for(var i=0;i<self._readyCallbacks.length;++i){var cb=self._readyCallbacks[i];cb.call(null,self)}self.mod._search()}}};Yi.prototype._fitRaty=function(){$.fn.raty.defaults.path=this.relativePath+"lib/plugins/raty/img";
$.fn.raty.defaults.hints=["极差","差","合格","好","极好"];$.fn.rating=$.fn.raty};Yi.prototype._fitParsley=function(){$.fn.parsley.defaults.namespace="verifier-";$.fn.parsley.defaults.successClass="verifier-success";$.fn.parsley.defaults.errorClass="verifier-error";$.fn.parsley.defaults.validationMinlength=1;$.fn.verify=$.fn.parsley};Yi.prototype.alert=function(message,callback){bootbox.alert(message,callback)};Yi.prototype.confirm=function(message,callback){bootbox.confirm(message,callback)};Yi.prototype.prompt=
function(title,callback){bootbox.prompt(title,callback)};Yi.prototype.dialog=function(options){bootbox.dialog(options)};Yi.prototype.hideDialog=function(){bootbox.hideAll()};Yi.prototype.pasteDialogTips=function(text,autoTimeout){var el=$(".bootbox");if(el.length>0){if(this._dialogTimer>0){clearTimeout(this._dialogTimer);this._dialogTimer=0}el=el.find(".bootbox-body");if(el.find("#_tip").length>0)el.find("#_tip").html("<h6>"+text+"</h6>");else el.append('<div id="_tip" class="text-center text-warning"><h6>'+
text+"</h6></div>");if(typeof autoTimeout!="undefined"){var self=this;this._dialogTimer=setTimeout(self.eraseDialogTips,autoTimeout)}}};Yi.prototype.eraseDialogTips=function(){var el=$(".bootbox");if(el.length>0){if(this._dialogTimer>0){clearTimeout(this._dialogTimer);this._dialogTimer=0}el=el.find("#_tip");el.remove()}};global.ModEvent={LOADED:"loaded",FAILED:"failed"};var ModManager=function(){this.context="";this.mods={};this.listeners=new HashMap};ModManager.prototype.getMod=function(name,version,
success,fail,debug){var url=this.context+"mod/"+name+"/"+version;if(debug!==undefined&&debug)url+="?_d=true";$.get(url,function(data,textStatus,jqXHR){success.call(null,data)},"json").fail(function(e){console.log('[Yi.Mod#getMod] Failed requests "'+url+'"');if(fail!==undefined)fail.call(null,name,version)})};ModManager.prototype.load=function(container,args,addition){var target=container;if(typeof target=="string")target=$("#"+container);var modName=target.data("mod");if(modName===undefined){console.log('[Yi.Mod#load] Can not find "data-mod" attribute value.');
return}var version=target.data("ver");if(version===undefined){console.log('[Yi.Mod#load] Can not find "data-ver" attribute value.');return}var context=this.context;var self=this;var url=context+"modloader/"+modName+"/"+version;$.post(url,function(data,textStatus,jqXHR){if(args!==undefined)data["args"]=args;data["context"]=context;var params={"_n":data["name"],"_v":data["version"],"_d":false};if(addition!==undefined&&addition!=null){addition["_n"]=params._n;addition["_v"]=params._v;addition["_d"]=
params._d;params=addition}data["params"]=params;data["contextPath"]=context+data.path;data["done"]=function(c,m){self._done(c,m)};var deps=data["deps"];if(deps!==undefined)self._predeps(deps,function(){target.fetch(data,data)});else target.fetch(data,data)},"json").fail(function(){console.log('[Yi.Mod#load] Failed requests "'+url+'"');self.notifyEvent(global.ModEvent.FAILED,target,{"name":modName,"version":version})})};ModManager.prototype.unload=function(container){};ModManager.prototype.deleteRemoteMod=
function(name,version,callback,fail){var url=this.context+"modmgm/delete/"+name+"/"+version;$.post(url,function(data,textStatus,jqXHR){callback.call(null,data)},"json").fail(function(){console.log('[Yi.Mod#deleteRemoteMod] Failed requests "'+url+'"');if(fail!==undefined)fail.call(null,name,version)})};ModManager.prototype.redeployDebug=function(name,version,callback,fail){var url=this.context+"modmgm/redeploy_d/"+name+"/"+version;$.post(url,function(data,textStatus,jqXHR){callback.call(null,data)},
"json").fail(function(){console.log('[Yi.Mod#redeployDebug] Failed requests "'+url+'"');if(fail!==undefined)fail.call(null,name,version)})};ModManager.prototype.newDebug=function(mod,done,fail){var url=this.context+"modmgm/new/"+mod.name+"/"+mod.version;$.post(url,JSON.stringify(mod),function(data,textStatus,jqXHR){done.call(null,data)},"json").fail(function(){console.log('[Yi.Mod#newDebug] Failed requests "'+url+'"');if(fail!==undefined)fail.call(null,mod)})};ModManager.prototype.deleteDebug=function(name,
version,done,fail){var url=this.context+"modmgm/delete_d/"+name+"/"+version;$.post(url,function(data,textStatus,jqXHR){done.call(null,data)},"json").fail(function(){console.log('[Yi.Mod#deleteDebug] Failed requests "'+url+'"');if(fail!==undefined)fail.call(null,name,version)})};ModManager.prototype.debug=function(containerId,mod,addition){var _debug={startTime:new Date};var container=$("#"+containerId);container.html("");mod["context"]=this.context;var params={"_n":mod["name"],"_v":mod["version"],
"_d":true};if(addition!==undefined&&addition!=null){addition["_n"]=params._n;addition["_v"]=params._v;addition["_d"]=params._d;params=addition}mod["params"]=params;mod["contextPath"]=this.context+"debugger/"+mod.path;var self=this;mod["done"]=function(c,m){self._done(c,m)};mod.debug=true;mod._debug=_debug;var deps=mod["deps"];if(deps!==undefined)this._predeps(deps,function(){container.fetch(mod,mod);_debug.endTime=new Date});else{container.fetch(mod,mod);_debug.endTime=new Date}};ModManager.prototype._predeps=
function(deps,callback){var checkCount=0;var aliases=deps["aliases"];var check=function(){++checkCount;if(checkCount==aliases.length)callback.call(null)};if(aliases!==undefined)for(var i=0;i<aliases.length;++i)common.use(aliases[i],function(){check()})};ModManager.prototype._done=function(container,mod){this.addMod(mod);this.notifyEvent(ModEvent.LOADED,container,mod)};ModManager.prototype._search=function(){var self=this;$(".mod").each(function(index,element){var el=$(this);var auto=el.attr("data-auto");
if(auto!==undefined&&auto=="true"){var args=el.data("args");var params=el.data("params");if(args!==undefined)try{var obj=eval(args);args=obj}catch(e){console.log('[Yi.Mod#_search] Parse "data-args" error')}if(params!==undefined)try{var obj=eval(params);params=obj}catch(e){console.log('[Yi.Mod#_search] Parse "data-params" error')}self.load(el,args,params)}})};ModManager.prototype.addMod=function(mod){this.mods[mod.name]=mod};ModManager.prototype.removeMod=function(name){delete this.mods[name]};ModManager.prototype.addListener=
function(event,listener){if(this.listeners.containsKey(event)){var list=this.listeners.get(event);if(list.indexOf(listener)<0)list.push(listener)}else this.listeners.put(event,[listener])};ModManager.prototype.removeListener=function(event,listener){if(this.listeners.containsKey(event)){var list=this.listeners.get(event);var index=list.indexOf(listener);if(index>=0){list.split(index,1);if(list.length==0)this.listeners.remove(event)}}};ModManager.prototype.notifyEvent=function(event,container,mod){if(this.listeners.containsKey(event)){var list=
this.listeners.get(event);var obj={event:event,container:container,mod:mod};for(var i=0;i<list.length;++i){var listener=list[i];listener.call(null,obj)}}};global.yi=new Yi})(this);
